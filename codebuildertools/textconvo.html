<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NBI – Text Convo Builder (No Errors)</title>
<style>
  :root { --ink:#0f172a; --muted:#6b7280; --bg:#f6f7fb; --card:#ffffff; --brand:#25408F; }
  * { box-sizing:border-box }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
  header { padding:16px 20px; background:var(--brand); color:#fff; }
  header h1 { margin:0; font-size:22px; line-height:1.2; }

  .wrap { display:grid; grid-template-columns: 480px 1fr; gap:18px; padding:18px; max-width:1200px; margin:0 auto; }
  .card { background:var(--card); border-radius:12px; box-shadow:0 8px 24px rgba(2,6,23,.06); }
  .card h2 { margin:0; padding:14px 16px; font-size:16px; border-bottom:1px solid #e5e7eb; }
  .card .body { padding:14px 16px; }

  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
  .row.thirds { grid-template-columns: 1fr 1fr 1fr; }
  .row.full { grid-template-columns:1fr; }
  label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
  input[type="text"], input[type="number"], input[type="url"], select, textarea {
    width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;
  }
  input[type="color"] { width:100%; height:36px; padding:0; border:1px solid #d1d5db; border-radius:8px; }
  textarea { min-height:84px; resize:vertical; }

  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button { appearance:none; border:0; background:#111827; color:#fff; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
  button.secondary { background:#334155; }
  .email-frame { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:16px; overflow:auto; }
  textarea#exportHtml { width:100%; min-height:200px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px; }
</style>
</head>
<body>
<header>
  <h1>NBICodeAcademy — Text Convo Builder</h1>
</header>

<div class="wrap">
  <!-- 1) EDITOR -->
  <section class="card">
    <h2>Editor</h2>
    <div class="body">
      <!-- Global styles -->
      <div class="row">
        <div>
          <label>Font family</label>
          <select id="fontFamily">
            <option value="Arial, Helvetica, sans-serif" selected>Arial, Helvetica, sans-serif</option>
            <option value="Helvetica, Arial, sans-serif">Helvetica, Arial, sans-serif</option>
            <option value="'Segoe UI', Arial, sans-serif">'Segoe UI', Arial, sans-serif</option>
            <option value="Georgia, serif">Georgia, serif</option>
            <option value="Tahoma, Geneva, sans-serif">Tahoma, Geneva, sans-serif</option>
          </select>
        </div>
        <div>
          <label>Base font size (px)</label>
          <input type="number" id="baseFont" min="10" step="1" value="14" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Card width (px)</label>
          <input type="number" id="cardWidth" min="280" step="10" value="500" />
        </div>
        <div>
          <label>Card padding (px)</label>
          <input type="number" id="cardPad" min="0" step="2" value="20" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Name color</label>
          <input type="color" id="nameColor" value="#1c4588" />
        </div>
        <div>
          <label>Name weight</label>
          <select id="nameWeight">
            <option value="bold" selected>Bold</option>
            <option value="600">600</option>
            <option value="700">700</option>
            <option value="normal">Normal</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Left bubble background</label>
          <input type="color" id="leftBg" value="#eff3f7" />
        </div>
        <div>
          <label>Left bubble text color</label>
          <input type="color" id="leftFg" value="#000000" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Right bubble background</label>
          <input type="color" id="rightBg" value="#218aff" />
        </div>
        <div>
          <label>Right bubble text color</label>
          <input type="color" id="rightFg" value="#ffffff" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Bubble radius (px)</label>
          <input type="number" id="bubbleRadius" min="0" step="1" value="10" />
        </div>
        <div>
          <label>Bubble padding (px)</label>
          <input type="number" id="bubblePad" min="4" step="1" value="10" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Avatar size (px)</label>
          <input type="number" id="avatarSize" min="20" step="1" value="50" />
        </div>
        <div>
          <label>Avatar radius (%)</label>
          <input type="number" id="avatarRadius" min="0" max="50" step="1" value="50" />
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #e5e7eb; margin:12px 0">

      <!-- Per-message inputs -->
      <div class="row thirds">
        <div><strong>Message</strong></div>
        <div><strong>Contact name</strong></div>
        <div><strong>Avatar URL</strong></div>
      </div>

      <div class="row thirds">
        <div>#1 (Left)</div>
        <div><input type="text" id="name_0" value="CONTACT NAME" /></div>
        <div><input type="url" id="avatar_0" value="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Jalen.png" /></div>
      </div>
      <div class="row full"><textarea id="text_0">Text 1 Goes Here and This Box Expands With Text</textarea></div>

      <div class="row thirds">
        <div>#2 (Right)</div>
        <div><input type="text" id="name_1" value="CONTACT NAME" /></div>
        <div><input type="url" id="avatar_1" value="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Mitch.png" /></div>
      </div>
      <div class="row full"><textarea id="text_1">Text 2</textarea></div>

      <div class="row thirds">
        <div>#3 (Left)</div>
        <div><input type="text" id="name_2" value="CONTACT NAME" /></div>
        <div><input type="url" id="avatar_2" value="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Jalen.png" /></div>
      </div>
      <div class="row full"><textarea id="text_2">Text 3</textarea></div>

      <div class="row thirds">
        <div>#4 (Right)</div>
        <div><input type="text" id="name_3" value="CONTACT NAME" /></div>
        <div><input type="url" id="avatar_3" value="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Mitch.png" /></div>
      </div>
      <div class="row full"><textarea id="text_3">Text 4</textarea></div>

      <div class="actions">
        <button id="apply">Apply Changes</button>
        <button class="secondary" id="resetAll">Reset to Original</button>
      </div>
    </div>
  </section>

  <!-- 2) LIVE PREVIEW -->
  <section class="card">
    <h2>Live Preview</h2>
    <div class="body"><div id="preview" class="email-frame"></div></div>
  </section>

  <!-- 3) HTML EXPORT -->
  <section class="card" style="grid-column: 1 / span 2;">
    <h2>Export HTML</h2>
    <div class="body">
      <textarea id="exportHtml" readonly></textarea>
      <div class="actions">
        <button id="copyHtml">Copy HTML</button>
        <button class="secondary" id="refreshHtml">Refresh Export</button>
      </div>
    </div>
  </section>
</div>

<!-- Your original snippet lives here -->
<template id="raw">
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Text Convo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body style="margin:0; padding:0; background-color:#f5f5f5; font-family:Arial, sans-serif;">
<table align="center" width="100%" cellpadding="0" cellspacing="0" bgcolor="#f5f5f5">
  <tr>
    <td align="center">
      <table width="500" cellpadding="0" cellspacing="0" bgcolor="#ffffff" style="padding:20px;">
        <tr>
          <td align="left" style="padding-bottom:20px;">
            <table cellpadding="0" cellspacing="0">
              <tr>
                <td valign="top" style="padding-right:10px;">
                  <img src="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Jalen.png" alt="Avatar 1" width="50" height="50" style="display:block; border-radius: 50%;">
                </td>
                <td valign="top">
                  <div style="color:#1c4588; font-weight:bold; margin-bottom:4px;">CONTACT NAME</div>
                  <div style="background-color:#eff3f7; padding:10px; color:#000000; font-size:14px; line-height:1.4; border-radius:10px;">
                    Text 1 Goes Here and This Box Expands With Text
                  </div>
                </td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td align="right" style="padding-bottom:20px;">
            <table cellpadding="0" cellspacing="0">
              <tr>
                <td valign="top" align="right">
                  <div style="color:#1c4588; font-weight:bold; text-align:right; margin-bottom:4px;">CONTACT NAME</div>
                  <div style="background-color:#218aff; padding:10px; color:#ffffff; font-size:14px; line-height:1.4; border-radius:10px;">
                    Text 2
                  </div>
                </td>
                <td valign="top" style="padding-left:10px;">
                  <img src="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Mitch.png" alt="Avatar 2" width="50" height="50" style="display:block; border-radius: 50%;">
                </td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td align="left" style="padding-bottom:20px;">
            <table cellpadding="0" cellspacing="0">
              <tr>
                <td valign="top" style="padding-right:10px;">
                  <img src="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Jalen.png" alt="Avatar 3" width="50" height="50" style="display:block; border-radius: 50%;">
                </td>
                <td valign="top">
                  <div style="color:#1c4588; font-weight:bold; margin-bottom:4px;">CONTACT NAME</div>
                  <div style="background-color:#eff3f7; padding:10px; color:#000000; font-size:14px; line-height:1.4; border-radius:10px;">
                    Text 3
                  </div>
                </td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td align="right" style="padding-bottom:20px;">
            <table cellpadding="0" cellspacing="0">
              <tr>
                <td valign="top" align="right">
                  <div style="color:#1c4588; font-weight:bold; text-align:right; margin-bottom:4px;">CONTACT NAME</div>
                  <div style="background-color:#218aff; padding:10px; color:#ffffff; font-size:14px; line-height:1.4; border-radius:10px;">
                    Text 4
                  </div>
                </td>
                <td valign="top" style="padding-left:10px;">
                  <img src="https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Mitch.png" alt="Avatar 4" width="50" height="50" style="display:block; border-radius: 50%;">
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
</body>
</html>
</template>

<script>
/* ---------- utils ---------- */
const $ = (id) => document.getElementById(id);
const qsa = (root, sel) => Array.from(root.querySelectorAll(sel));
const escapeHtml = (t) => String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
const setMultiline = (el, text) => { el.innerHTML = escapeHtml(text).replace(/\n/g, "<br>"); };

/* Extract only the <body>…</body> content from a full HTML doc string */
function extractBody(html) {
  const m = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
  return m ? m[1] : html;
}

let msgMap = []; // [{ side, row, img, nameDiv, bubbleDiv }]

function loadSnippet() {
  const rawHtml = $('#raw').innerHTML;
  $('#preview').innerHTML = extractBody(rawHtml);

  const card = $('#preview').querySelector('table[width="500"]');
  if (!card) { refreshExport(); return; }

  const rows = qsa(card, '> tbody > tr');
  msgMap = [];
  rows.forEach((tr) => {
    const inner = tr.querySelector('table');
    if (!inner) return;
    const imgs = qsa(inner, 'img');
    const divs = qsa(inner, 'div');
    if (!imgs.length || divs.length < 2) return;

    const outerTd = tr.querySelector('td[align]');
    const side = outerTd && /right/i.test(outerTd.getAttribute('align')) ? 'right' : 'left';
    const img = side === 'left' ? imgs[0] : imgs[imgs.length - 1];
    const nameDiv = divs[0];
    const bubbleDiv = divs[1];
    msgMap.push({ side, row: tr, img, nameDiv, bubbleDiv });
  });

  refreshExport();
}

function applyAll() {
  const card = $('#preview').querySelector('table[width="500"]');
  if (!card) return;

  // globals
  const ff = $('#fontFamily').value;
  const base = +$('#baseFont').value || 14;
  const w = +$('#cardWidth').value || 500;
  const pad = +$('#cardPad').value || 20;

  const nameColor = $('#nameColor').value;
  const nameWeight = $('#nameWeight').value;

  const leftBg = $('#leftBg').value, leftFg = $('#leftFg').value;
  const rightBg = $('#rightBg').value, rightFg = $('#rightFg').value;

  const radius = +$('#bubbleRadius').value || 10;
  const bubblePad = +$('#bubblePad').value || 10;

  const avSize = Math.max(1, +$('#avatarSize').value || 50);
  const avRad = Math.max(0, Math.min(50, +$('#avatarRadius').value || 50));

  // card width + padding
  card.setAttribute('width', String(w));
  const existingStyle = card.getAttribute('style') || '';
  card.setAttribute('style', `padding:${pad}px;${existingStyle.replace(/padding:[^;]+;?/i,'')}`);

  // base font + family on wrapper
  const wrapper = $('#preview');
  const ws = wrapper.getAttribute('style') || '';
  wrapper.setAttribute('style', `font-family:${ff}; font-size:${base}px; ${ws.replace(/font-(family|size):[^;]+;?/gi,'')}`);

  // update message content/styles
  const pairs = [
    { name:'#name_0', text:'#text_0', av:'#avatar_0' },
    { name:'#name_1', text:'#text_1', av:'#avatar_1' },
    { name:'#name_2', text:'#text_2', av:'#avatar_2' },
    { name:'#name_3', text:'#text_3', av:'#avatar_3' },
  ];

  msgMap.forEach((m, i) => {
    const nm = document.querySelector(pairs[i].name);
    const tx = document.querySelector(pairs[i].text);
    const av = document.querySelector(pairs[i].av);
    if (!nm || !tx || !av) return;

    m.nameDiv.textContent = nm.value;
    setMultiline(m.bubbleDiv, tx.value);

    try { m.img.setAttribute('src', av.value); } catch {}

    // name styles
    const ns = m.nameDiv.getAttribute('style') || '';
    m.nameDiv.setAttribute('style',
      `color:${nameColor}; font-weight:${nameWeight}; margin-bottom:4px; ${m.side==='right'?'text-align:right;':''} ${ns.replace(/(color|font-weight|font-size|text-align):[^;]+;?/gi,'')}`
    );

    // bubble styles
    const isRight = m.side === 'right';
    const bg = isRight ? rightBg : leftBg;
    const fg = isRight ? rightFg : leftFg;
    const bs = m.bubbleDiv.getAttribute('style') || '';
    m.bubbleDiv.setAttribute('style',
      `background-color:${bg}; padding:${bubblePad}px; color:${fg}; font-size:${base}px; line-height:1.4; border-radius:${radius}px; ${bs.replace(/(background-color|color|font-size|line-height|padding|border-radius):[^;]+;?/gi,'')}`
    );

    // avatar sizing/roundness
    m.img.setAttribute('width', String(avSize));
    m.img.setAttribute('height', String(avSize));
    const isty = m.img.getAttribute('style') || '';
    m.img.setAttribute('style', `display:block; border-radius:${avRad}%; ${isty.replace(/(border-radius|display):[^;]+;?/gi,'')}`);
  });

  refreshExport();
}

function refreshExport(){ $('#exportHtml').value = $('#preview').innerHTML.trim(); }
function copyExport(){
  const t = $('#exportHtml').value;
  navigator.clipboard.writeText(t).then(()=>alert('HTML copied!'))
    .catch(()=>{ $('#exportHtml').select(); document.execCommand('copy'); alert('HTML copied (fallback).'); });
}
function resetAll(){ loadSnippet(); }

/* wire up */
$('#apply').addEventListener('click', applyAll);
$('#resetAll').addEventListener('click', resetAll);
$('#refreshHtml').addEventListener('click', refreshExport);
$('#copyHtml').addEventListener('click', copyExport);

/* init */
loadSnippet();
</script>
</body>
</html>
