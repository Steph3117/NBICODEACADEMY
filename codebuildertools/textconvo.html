<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Text Convo Email Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ink:#0f172a; --bg:#f7f7fb; --card:#ffffff; --brand:#1c4588;
      --border:#e5e7eb; --muted:#6b7280;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    header{
      background:var(--brand); color:#fff; padding:16px 20px;
      display:flex; align-items:center; justify-content:space-between;
    }
    header h1{ margin:0; font-size:18px; }
    header .actions{ display:flex; gap:8px; }
    .btn{
      border:1px solid #ffffff33; background:#fff; color:var(--brand);
      padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    .btn.secondary{ background:transparent; color:#fff; border-color:#ffffff88; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .wrap{
      display:grid; grid-template-columns:380px 1fr; gap:16px; padding:16px;
      max-width:1400px; margin:0 auto;
    }
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:14px;
      overflow:hidden;
    }
    .panel h2{
      font-size:16px; margin:0; padding:12px 14px; background:#f9fafb; border-bottom:1px solid var(--border);
    }
    .panel .body{ padding:14px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .field{ margin-bottom:10px; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .field input[type="text"],
    .field input[type="url"],
    .field input[type="number"],
    .field textarea,
    .field select{
      width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:14px; background:#fff;
    }
    .field input[type="color"]{
      width:100%; height:38px; padding:2px; border:1px solid var(--border); border-radius:10px; background:#fff;
    }
    .bubble-card{
      border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; background:#fff;
    }
    .bubble-title{ font-weight:700; font-size:13px; color:var(--brand); margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; }
    .mini-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .code-area{
      width:100%; height:280px; resize:vertical; border:1px solid var(--border);
      border-radius:12px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; background:#0b1020; color:#e6edf3;
    }
    .preview-wrap{ height:700px; border:0; width:100%; background:#fff; }
    .toolbar{ display:flex; gap:8px; margin-bottom:10px; }
    .hint{ font-size:12px; color:var(--muted); }
    .grid-gap{ display:grid; gap:10px; }
    .divider{ height:1px; background:var(--border); margin:12px 0; }
  </style>
</head>
<body>
<header>
  <h1>Text Convo Email Builder</h1>
  <div class="actions">
    <button class="btn secondary" id="btnAsk">Set # of Bubbles</button>
    <button class="btn" id="btnAdd">+ Add Bubble</button>
    <button class="btn" id="btnRender">Render & Update Code</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Controls -->
  <section class="panel" id="controlsPanel">
    <h2>Conversation Settings</h2>
    <div class="body grid-gap">
      <div class="row">
        <div class="field">
          <label for="canvasWidth">Email Canvas Width (px)</label>
          <input type="number" id="canvasWidth" min="320" step="10" value="500">
        </div>
        <div class="field">
          <label for="pageBg">Email Page Background</label>
          <input type="color" id="pageBg" value="#f5f5f5">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="leftNameColor">Left Name Color</label>
          <input type="color" id="leftNameColor" value="#1c4588">
        </div>
        <div class="field">
          <label for="rightNameColor">Right Name Color</label>
          <input type="color" id="rightNameColor" value="#1c4588">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="leftBubbleBg">Left Bubble BG</label>
          <input type="color" id="leftBubbleBg" value="#eff3f7">
        </div>
        <div class="field">
          <label for="leftTextColor">Left Text Color</label>
          <input type="color" id="leftTextColor" value="#000000">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="rightBubbleBg">Right Bubble BG</label>
          <input type="color" id="rightBubbleBg" value="#218aff">
        </div>
        <div class="field">
          <label for="rightTextColor">Right Text Color</label>
          <input type="color" id="rightTextColor" value="#ffffff">
        </div>
      </div>

      <div class="divider"></div>

      <div id="bubblesForm" class="grid-gap"></div>
      <div class="hint">Tip: Change any field and click “Render & Update Code”.</div>
    </div>
  </section>

  <!-- RIGHT: Preview + Code -->
  <section class="panel">
    <h2>Live Preview (Email-Safe Tables)</h2>
    <div class="body">
      <iframe id="preview" class="preview-wrap" title="Preview"></iframe>
      <div class="divider"></div>
      <div class="toolbar">
        <button class="btn" id="btnCopy">Copy Code</button>
        <button class="btn" id="btnDownload">Download HTML</button>
      </div>
      <textarea id="code" class="code-area" spellcheck="false"></textarea>
      <div class="hint">This is the exact HTML your email tool can use.</div>
    </div>
  </section>
</div>

<script>
(function(){
  // Default avatars from your example
  const DEFAULT_LEFT_AVATAR  = "https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Jalen.png";
  const DEFAULT_RIGHT_AVATAR = "https://prod.cdn.everyaction.com/images/van/NGP/NGP30/1/90471/images/Mitch.png";

  const state = {
    canvasWidth: 500,
    pageBg: "#f5f5f5",
    nameColorLeft: "#1c4588",
    nameColorRight: "#1c4588",
    bubbleLeftBg: "#eff3f7",
    bubbleLeftText: "#000000",
    bubbleRightBg: "#218aff",
    bubbleRightText: "#ffffff",
    bubbles: [] // { side:'left'|'right', name, avatar, text }
  };

  // UI elements
  const elWidth = document.getElementById('canvasWidth');
  const elPageBg = document.getElementById('pageBg');
  const elLeftNameCol = document.getElementById('leftNameColor');
  const elRightNameCol = document.getElementById('rightNameColor');
  const elLeftBg = document.getElementById('leftBubbleBg');
  const elLeftText = document.getElementById('leftTextColor');
  const elRightBg = document.getElementById('rightBubbleBg');
  const elRightText = document.getElementById('rightTextColor');

  const elForm = document.getElementById('bubblesForm');
  const elPreview = document.getElementById('preview');
  const elCode = document.getElementById('code');

  const btnRender = document.getElementById('btnRender');
  const btnCopy = document.getElementById('btnCopy');
  const btnDownload = document.getElementById('btnDownload');
  const btnAdd = document.getElementById('btnAdd');
  const btnAsk = document.getElementById('btnAsk');

  // Helpers
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  function bubbleCard(index, bubble){
    const idx = index + 1;
    return `
      <div class="bubble-card" data-index="${index}">
        <div class="bubble-title">
          <span>Bubble #${idx}</span>
          <button class="btn" type="button" data-action="remove" data-index="${index}">Remove</button>
        </div>
        <div class="mini-row">
          <div class="field">
            <label>Side</label>
            <select data-field="side">
              <option value="left" ${bubble.side==='left'?'selected':''}>Left</option>
              <option value="right" ${bubble.side==='right'?'selected':''}>Right</option>
            </select>
          </div>
          <div class="field">
            <label>Display Name</label>
            <input type="text" data-field="name" placeholder="CONTACT NAME" value="${escapeHtml(bubble.name)}" />
          </div>
        </div>
        <div class="field">
          <label>Avatar Image URL</label>
          <input type="url" data-field="avatar" placeholder="https://..." value="${escapeHtml(bubble.avatar)}" />
        </div>
        <div class="field">
          <label>Message Text</label>
          <textarea rows="3" data-field="text" placeholder="Type message...">${escapeHtml(bubble.text)}</textarea>
        </div>
      </div>
    `;
  }

  function renderForm(){
    elForm.innerHTML = state.bubbles.map((b,i)=>bubbleCard(i,b)).join("");
  }

  function attachFormEvents(){
    elForm.addEventListener('input', (e)=>{
      const card = e.target.closest('.bubble-card');
      if(!card) return;
      const idx = Number(card.dataset.index);
      const field = e.target.dataset.field;
      if(!field) return;
      state.bubbles[idx][field] = e.target.value;
    });

    elForm.addEventListener('click', (e)=>{
      const action = e.target.dataset.action;
      if(action === 'remove'){
        const idx = Number(e.target.dataset.index);
        state.bubbles.splice(idx,1);
        renderForm(); // re-render to reindex
      }
    });
  }

  function buildMessageRow(b, globals){
    const isLeft = b.side === 'left';
    const alignCell = isLeft ? 'left' : 'right';
    const nameColor = isLeft ? globals.nameColorLeft : globals.nameColorRight;
    const bubbleBg = isLeft ? globals.bubbleLeftBg : globals.bubbleRightBg;
    const textColor = isLeft ? globals.bubbleLeftText : globals.bubbleRightText;

    // Left layout = [avatar][name+text]
    // Right layout = [name+text][avatar]
    const leftCells = isLeft ? `
      <td valign="top" style="padding-right:10px;">
        <img src="${escapeHtml(b.avatar)}" alt="Avatar" width="50" height="50" style="display:block; border-radius: 50%;">
      </td>
      <td valign="top">
        <div style="color:${nameColor}; font-weight:bold; margin-bottom:4px;">${escapeHtml(b.name)}</div>
        <div style="background-color:${bubbleBg}; padding:10px; color:${textColor}; font-size:14px; line-height:1.4; border-radius:10px;">
          ${escapeHtml(b.text)}
        </div>
      </td>
    ` : `
      <td valign="top" align="right">
        <div style="color:${nameColor}; font-weight:bold; text-align:right; margin-bottom:4px;">${escapeHtml(b.name)}</div>
        <div style="background-color:${bubbleBg}; padding:10px; color:${textColor}; font-size:14px; line-height:1.4; border-radius:10px;">
          ${escapeHtml(b.text)}
        </div>
      </td>
      <td valign="top" style="padding-left:10px;">
        <img src="${escapeHtml(b.avatar)}" alt="Avatar" width="50" height="50" style="display:block; border-radius: 50%;">
      </td>
    `;

    return `
      <tr>
        <td align="${alignCell}" style="padding-bottom:20px;">
          <table cellpadding="0" cellspacing="0" role="presentation">
            <tr>
              ${leftCells}
            </tr>
          </table>
        </td>
      </tr>
    `;
  }

  function buildEmailHtml(){
    const g = {
      width: Number(state.canvasWidth) || 500,
      pageBg: state.pageBg,
      nameColorLeft: state.nameColorLeft,
      nameColorRight: state.nameColorRight,
      bubbleLeftBg: state.bubbleLeftBg,
      bubbleLeftText: state.bubbleLeftText,
      bubbleRightBg: state.bubbleRightBg,
      bubbleRightText: state.bubbleRightText
    };

    const messages = state.bubbles.map(b => buildMessageRow(b, g)).join("\n");

    return `<!DOCTYPE html>
<html lang="en">
<head>
  <title>Text Convo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body style="margin:0; padding:0; background-color:${g.pageBg}; font-family:Arial, sans-serif;">

<!-- Outer Centered Container -->
<table align="center" width="100%" cellpadding="0" cellspacing="0" bgcolor="${g.pageBg}">
  <tr>
    <td align="center">
      <table width="${g.width}" cellpadding="0" cellspacing="0" bgcolor="#ffffff" style="padding:20px;">

        ${messages}

      </table>
    </td>
  </tr>
</table>

</body>
</html>`;
  }

  function updatePreviewAndCode(){
    // Sync globals from inputs
    state.canvasWidth = Number(elWidth.value) || 500;
    state.pageBg = elPageBg.value || "#f5f5f5";
    state.nameColorLeft = elLeftNameCol.value || "#1c4588";
    state.nameColorRight = elRightNameCol.value || "#1c4588";
    state.bubbleLeftBg = elLeftBg.value || "#eff3f7";
    state.bubbleLeftText = elLeftText.value || "#000000";
    state.bubbleRightBg = elRightBg.value || "#218aff";
    state.bubbleRightText = elRightText.value || "#ffffff";

    const html = buildEmailHtml();
    elCode.value = html;

    const doc = elPreview.contentDocument || elPreview.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();
  }

  function copyToClipboard(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
  }

  function download(filename, text){
    const blob = new Blob([text], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function addBubble(side = 'left', name='CONTACT NAME', avatar='', text=''){
    const defaultAvatar = side === 'left' ? DEFAULT_LEFT_AVATAR : DEFAULT_RIGHT_AVATAR;
    state.bubbles.push({
      side,
      name,
      avatar: avatar || defaultAvatar,
      text
    });
  }

  function askHowMany(){
    const countStr = prompt('How many text bubbles would you like to start with?', '4');
    if(countStr === null) return; // cancelled
    const n = Math.max(0, Math.min(50, Number(countStr) || 0));
    state.bubbles = [];
    for(let i=0;i<n;i++){
      const side = i % 2 === 0 ? 'left' : 'right';
      addBubble(
        side,
        'CONTACT NAME',
        '',
        side === 'left'
          ? (i===0 ? 'Text 1 Goes Here and This Box Expands With Text' : `Text ${i+1}`)
          : `Text ${i+1}`
      );
    }
    renderForm();
    updatePreviewAndCode();
  }

  // Wire globals
  [elWidth, elPageBg, elLeftNameCol, elRightNameCol, elLeftBg, elLeftText, elRightBg, elRightText]
    .forEach(el => el.addEventListener('input', updatePreviewAndCode));

  btnRender.addEventListener('click', updatePreviewAndCode);
  btnCopy.addEventListener('click', ()=> copyToClipboard(elCode.value));
  btnDownload.addEventListener('click', ()=> download('text-convo.html', elCode.value));
  btnAdd.addEventListener('click', ()=>{
    // Alternate sides when adding
    const side = state.bubbles.length % 2 === 0 ? 'left' : 'right';
    addBubble(side, 'CONTACT NAME', '', `Text ${state.bubbles.length+1}`);
    renderForm();
    updatePreviewAndCode();
  });
  btnAsk.addEventListener('click', askHowMany);

  // Init
  attachFormEvents();
  // First ask the user:
  askHowMany();

})();
</script>
</body>
</html>
